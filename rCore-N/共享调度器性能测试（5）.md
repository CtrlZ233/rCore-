## 实验设置

当前的实验框架下，只考虑衡量切换开销。

客户端要尽可能少地影响服务端，因此采用协程模型。

### Lab1

测量线程与协程的组合方式对性能的影响。

任务优先级设置的组合（三种）和模型设置的组合（三种），共九组实验。

- 通过相同优先级设置的不同模型组合的性能对比，分析模型切换的性能开销。
- 通过不同优先级设置的相同模型组合的性能对比，分析优先级设置的影响。

### Lab2
- 测量不同优先级连接的性能指标，目前只能设置协程模型下的优先级。
- 测量不同CPU数量下可保证的连接数（？比较模糊）

### Lab3

测试计算量对性能的影响。

不同计算量（3种）下的9个组合（任务优先级设置的组合（三种）和模型设置的组合（三种）），共27组实验。


## 三个子任务都是线程模型。

matrix size: 1   ;   send timer interval: 50 ms  ； run time limit: 5000 ms

|连接数| 1 |2 | 4 | 8 | 16 | 32 | 64 | 128 | 256 |
|---|---|---|---|---|---|---|---|---| --- |
| 吞吐量(请求数) |98 | 196  | 392 |784  |1568 | 2303 |4430 | 7682| |
| 平均时延(um) |307 | 462  |  840| 1864 |4644 |13758 |46967|112598 | |
| 时延标准差 |100 |162 | 340 |808  |1859 | 5387|14892 |177153 | |


matrix size: 20   ;   send timer interval: 50 ms  ； run time limit: 5000 ms

|连接数| 1 |2 | 4 | 8 | 16 | 32 | 64 | 128 | 256 |
|---|---|---|---|---|---|---|---|---| --- |
| 吞吐量(请求数) |98 | 196  | 392 |774  |1043 | 1198 |1390 |1410 | |
| 平均时延(um) |488 | 621  |  983| 2106 |4930 |14385 |62071 |168289 | |
| 时延标准差 |103 |156| 331 |855  |1968 | 5843|66024 |123364 | |


## 三个子任务都是协程模型。

matrix size: 20   ;   send timer interval: 50 ms  ； run time limit: 5000 ms  prio(receive, server, sender) = (2, 2, 2)

|连接数| 1 |2 | 4 | 8 | 16 | 32 | 64 | 128 | 256 |
|---|---|---|---|---|---|---|---|---| --- |
| 吞吐量(请求数) |98 | 196  | 392 |784  |1568 | 3136 |6265 |12471 | |
| 平均时延(um) |497 | 552  |  602| 712 |855|1064 |1339 |2231 | |
| 时延标准差 |112 |  126 | 156 |245  |518 | 646| 1072|2201 | |

matrix size: 1   ;   send timer interval: 50 ms  ； run time limit: 5000 ms  prio(receive, server, sender) = (2, 2, 2)

|连接数| 1 |2 | 4 | 8 | 16 | 32 | 64 | 128 | 256 |
|---|---|---|---|---|---|---|---|---| --- |
| 吞吐量(请求数) |98 | 196  | 392 |784  |1568 | 3136 |6260 |12489 | |
| 平均时延(um) |380 | 402  |  541| 596 |655|866 |1187 |1622 | |
| 时延标准差 |96 |  100 | 158 |239  |518 | 662| 1028|1951 | |


matrix size: 1   ;   send timer interval: 100 ms  ； run time limit: 5000 ms  prio(receive, server, sender) = (4, 3, 2)

|连接数| 1 |2 | 4 | 8 | 16 | 32 | 64 | 128 | 256 |
|---|---|---|---|---|---|---|---|---| --- |
| 吞吐量(请求数) |46 | 92  | 184 |368  |736 | 1472 |2944 |5838 | |
| 平均时延(um) |463 | 496  |  617| 729 |883|1079 |1499 |2091 | |
| 时延标准差 |49 |  76 | 120 |221  |351 | 520| 3202|3023 | |


matrix size: 1   ;   send timer interval: 100 ms  ； run time limit: 5000 ms  prio(receive, server, sender) = (2, 3, 4)

|连接数| 1 |2 | 4 | 8 | 16 | 32 | 64 | 128 | 256 |
|---|---|---|---|---|---|---|---|---| --- |
| 吞吐量(请求数) |46 | 92  | 184 |368  |736 | 1472 |2944 |5867 | |
| 平均时延(um) |478 | 560  |  597| 751 |827|1024 |1497 |2614 | |
| 时延标准差 |68 |  66 | 142 |784  |328 | 881| 1736|4205 | |



## 设置不同优先级组的连接，测量实验和吞吐量。

matrix size: 40   ;   send timer interval: 100 ms  ； run time limit: 5000 ms  prio(receive, server, sender) = (2, 2, 2) CLIENT_POLL_THREDS: 1

Server虚拟CPU只有1个时

|优先级| 1 |2 | 3 | 4 | 5 | 6 | 7 |
|---|---|---|---|---|---|---|---|
| 吞吐量(请求数) |696 | 696  | 696 |696  |696 | 695 |616 |
| 平均时延(um) |10513 | 13937  |  21241| 26176 |30817|35006 |41582 |
| 时延标准差 |7102 |  8164 | 12884 |16473  |20763 | 25563| 36488|

Server虚拟CPU有2个时

|优先级| 1 |2 | 3 | 4 | 5 | 6 | 7 |
|---|---|---|---|---|---|---|---|
| 吞吐量(请求数) |768 | 768  | 768 |768  |768 | 768 |768 |
| 平均时延(um) |1837 | 2018  |  2724| 6090 |15220|27958 |38401 |
| 时延标准差 |812 |  801 | 1889 |5737  |9788 | 10791| 10930|

Server虚拟CPU有3个时

|优先级| 1 |2 | 3 | 4 | 5 | 6 | 7 |
|---|---|---|---|---|---|---|---|
| 吞吐量(请求数) |768 | 768  | 768 |768  |768 | 768 |768 |
| 平均时延(um) |1969 | 2021  |  2077| 2219 |2551|3500 |5981 |
| 时延标准差 |1281 |  1301 | 1407 |1625  |2586 | 4861| 8419|

Server虚拟CPU有4个时

|优先级| 1 |2 | 3 | 4 | 5 | 6 | 7 |
|---|---|---|---|---|---|---|---|
| 吞吐量(请求数) |768 | 768  | 768 |768  |768 | 768 |768 |
| 平均时延(um) |2169 | 2200  |  2234| 2294 |2400|2588 |2998 |
| 时延标准差 |1824 |  1983 | 2293 |2339  |2719 | 3345| 4495|



# Lab

三个子任务全为进程和全为协程的对比：

横轴时连接数（2的幂次）。

Matrix 1 thread是指线程模型下，计算任务的计算量为 1 * 1 的矩阵运算，其他以此类推。

![](../image/Pasted-image-20230306193532.png)


![](../image/Pasted-image-20230306193702.png)

时延抖动和平均时延比较类似。


协程模型下不同优先级连接的时延和抖动如下：
横轴为连接优先级，Server 1 指的是服务端用1个虚拟CPU（线程）来执行，其他以此类推。

![](../image/Pasted-image-20230306194020.png)


![](../image/Pasted-image-20230306194042.png)
